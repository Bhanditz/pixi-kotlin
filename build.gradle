group = 'net.abesto.kotlin.js.pixi'
version = '0.0.1'

buildscript {
	ext.kotlinVersion = '0.1-SNAPSHOT'
	ext.kotlinGradlePluginVersion = '0.1-SNAPSHOT'
	ext.kotlinHome = "${System.env.HOME}/Library/Application Support/IdeaIC14/Kotlin"
	ext.kotlincJs = "$kotlinHome/kotlinc/bin/kotlinc-js"
	ext.kotlinJsLib = "$kotlinHome/kotlinc/lib/kotlin-jslib.jar"
	ext.kotlinJs = "$kotlinHome/kotlinc/lib/kotlin.js"

	repositories {
		mavenCentral()
		maven { url 'http://oss.sonatype.org/content/repositories/snapshots' }
	}
	dependencies {
		classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinGradlePluginVersion"
	}
}

subprojects {
	apply plugin: 'kotlin'

	task copyKotlinJs(type: Copy) {
		from "$kotlinJs"
		into "$projectDir/web/js/lib"
	}

	repositories {
		mavenCentral()
		maven { url 'http://oss.sonatype.org/content/repositories/snapshots' }
	}

	dependencies {
		compile "org.jetbrains.kotlin:kotlin-stdlib:$kotlinVersion"
	}

	sourceSets {
		main.java.srcDirs += 'src/main/kotlin'
		test.java.srcDirs += 'src/test/kotlin'
	}
}

project(':pixi-kotlin') {
	ext.libraryFiles = [kotlinJsLib]

	dependencies {
		compile files(kotlinJsLib)
	}

	task build(overwrite: true) {
		logger.info "Definitions are not compiled, we only build a source jar"
	}

	task jarSources(type:Jar){
		from sourceSets.main.allSource
		classifier = 'source'
	}
}

project(':examples') {
	subprojects {
		ext.jsFile = "app"
		ext.output = { "$projectDir/web/js/app/${jsFile}.js" }
		ext.libraryFiles = [kotlinJsLib, project(':pixi-kotlin').tasks.jarSources.archivePath]
		dependencies {
			compile files(kotlinJsLib)
			compile project(':pixi-kotlin')
		}

		task copyKotlinSourceIntoWeb(type: Copy) {
			from "src/main/kotlin"
			into "web/kotlin"
		}

		ext.originalExampleUrl = "http://www.goodboydigital.com/pixijs/examples/${project.name}/"
		ext.originalExampleText = { project.originalExampleUrl }
		ext.originalExampleSourceUrl = "view-source:http://www.goodboydigital.com/pixijs/examples/${project.name}/"
		ext.originalExampleSourceText = { project.originalExampleSourceUrl }
		ext.title = "PIXI Example ${project.name}"
		task generateIndexHtml(type: Copy) {
			from "${project(":examples").projectDir}/src/templates"
			into "web"
			expand(project: project)
		}

		task build(overwrite: true) {
			dependsOn copyKotlinJs
			dependsOn ':pixi-kotlin:jarSources'
			dependsOn copyKotlinSourceIntoWeb
			dependsOn generateIndexHtml

			ext.sources = sourceSets.main.allSource.files
			inputs.files sources

			outputs.file output()

			doLast {
				exec {
					commandLine("bash", kotlincJs, "-verbose", "-version",
							"-output", output(),
							"-library-files", libraryFiles.join(','), *sources.toList())
				}
			}
		}

		task test(overwrite: true) {
			logger.info "JS testing not implemented"
		}
	}
}

project(':examples:pairs') {
	ext.originalExampleUrl = "http://www.emanueleferonato.com/2014/02/26/complete-html5-concentration-game-made-with-pixi-js/"
	ext.originalExampleSourceUrl = originalExampleUrl
	ext.originalExampleSourceText = { "Same as above, scroll down a bit on the page" }
}

// Examples from http://www.pixijs.com/examples/
project(':examples:1')
project(':examples:2')

